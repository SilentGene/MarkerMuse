# MarkerMuse

MarkerMuse is a Python-based evaluation toolkit designed to identify the best-performing marker genes for computing alpha diversity from **SingleM** outputs. It analyzes OTU tables generated by SingleM and scores each marker gene using expert-derived and data-driven criteria.

This tool is useful when working with microbial community sequencing data where SingleM is used to detect marker genes across metagenomic or metatranscriptomic samples.

> [!NOTE]
> This library is still under active development. The vision is to evolve it into a comprehensive toolkit that empowers researchers to cherry-pick the most suitable marker genes from their metagenomic datasets for alpha/beta diversity analyses, essentially bringing 16S amplicon sequencing capabilities to shotgun metagenomics. Future roadmap includes support for additional marker gene profiling tools beyond SingleM, plus enhanced visualization capabilities for downstream analyses. Stay tuned or drop your feature requests! üß¨

## ‚ú® Features

* Accepts multiple SingleM OTU tables as input.
* Supports **two scoring modes**:

  * **Expert preset mode** ‚Äî heuristic scoring based on marker coverage consistency, richness, and stability.
  * **Data-driven mode** ‚Äî uses SingleM taxonomic-profile output to fit regression-based marker performance weights and rank markers according to how well they predict observed taxonomic coverage.
* Computes and normalizes multiple evaluation metrics, including:

  * OTU richness
  * Shannon diversity
  * Coverage variance across samples
  * Correlation to taxonomic-profile coverage
  * Replicate stability (bootstrapped)
* Produces a combined score and ranking of marker genes.
* Optional metadata input allows ANOVA-based group-separation scoring.
* Exports summary tables and visualizations (heatmap + top markers barplot).

---

## üì• Input Requirements

### 1. SingleM OTU tables (`*_singlem.otu.tsv`)

Tab-separated format containing:

```
gene    sample    sequence    num_hits    coverage    taxonomy
```

All OTU files for different samples should be placed in one folder.

### 2. (Optional) SingleM taxonomic-profile files (`*_singlem.tax.tsv`)

Required only for **data-driven mode**.

```
sample    coverage    taxonomy
```

This file provides average per-taxon coverage computed across all markers.

### 3. (Optional) Metadata file (`metadata.tsv`)

Must include:

```
sample    group
```

Used for group-separation scoring.

---

## üöÄ Installation

MarkerMuse is a pure-Python script.

### Install dependencies:

```bash
pip install pandas numpy scipy matplotlib
```

Clone or download this repository, and run the script directly.

---

## üß™ Usage

### Basic usage (expert mode auto-selected)

If you do not supply a taxonomic profile (`--taxprof`), the script auto-selects expert heuristic scoring:

```bash
python markermuse.py \
  --input_folder /path/to/otu_files \
  --otu_suf _singlem.otu.tsv
```

### Data-driven mode (auto-selected when `--taxprof` provided)

Provide a taxonomic profile to enable data-driven scoring:

```bash
python markermuse.py \
  --input_folder /path/to/otu_files \
  --otu_suf _singlem.otu.tsv \
  --taxprof _singlem.tax.tsv
```

### With metadata

```bash
python markermuse.py \
    --input_folder otu/ \
    --otu_suf _singlem.otu.tsv \
    --mode expert \
    --metadata metadata.tsv
```

### Optional arguments

| Argument             | Description                                          |
| -------------------- | ---------------------------------------------------- |
| `--out_prefix`       | Output file prefix inside output folder (default: `marker_scores`) |
| `-o`, `--output_folder` | Output directory (default: `marker_muse_output`, auto-created) |
| `--bootstrap_n`      | Number of bootstrap replicates for stability scoring |
| `--rarefaction_reps` | Rarefaction resampling repetitions                   |
| `--taxprof`          | Suffix or path to SingleM taxonomic-profile (enables data-driven mode) |
| `--metadata`         | Metadata TSV with `sample` & `group` for group ANOVA |
| `--min_markers_for_fit` | Minimum markers with taxprof to attempt regression |

---

## üìä Output Files

MarkerMuse generates the following outputs:

### 1. **`<output_folder>/<prefix>.tsv`**

Comprehensive tab-separated marker scoring table (sorted descending by `score`; `rank` is first column) written into the specified output folder. Columns include:

* `n_samples`: Number of samples in which the marker is detected
* `n_otus`: Total OTUs detected for the marker
* `mean_richness`: Average number of OTUs per sample
* `presence_rate`: Fraction of samples where the marker is present
* `singleton_rate`: Fraction of OTUs observed only once
* `cv_shannon`: Coefficient of variation of Shannon diversity across samples
* `slope_rarefaction`: Slope of rarefaction curve for the marker
* `F_group`: ANOVA F-statistic for group separation (if metadata provided)
* `mean_corr_taxprof`: Mean correlation between marker profile and taxonomic profile (data-driven mode)
* `score`: Combined weighted score
* `rank`: Rank of marker based on final score
* `mean_corr_taxprof_norm`: Normalized mean correlation
* `F_group_norm`: Normalized F_group
* `presence_rate_norm`: Normalized presence rate
* `mean_richness_norm`: Normalized mean richness
* `cv_shannon_norm`: Normalized CV of Shannon diversity
* `slope_rarefaction_norm`: Normalized rarefaction slope
* `singleton_rate_norm`: Normalized singleton rate

### 2. **`<output_folder>/<prefix>_heatmap.png`**

Heatmap of normalized marker metrics.

### 3. **`<output_folder>/<prefix>_topbar.png`**

Barplot of top-scoring markers.

### 4. **`<output_folder>/<prefix>_fitted_weights.txt`** (data-driven mode only)

### 5. **`<output_folder>/<prefix>_best_<MARKER>_otu.tsv`**

OTU table for the highest-scoring marker gene. `<MARKER>` is the sanitized marker id (non-alphanumeric characters replaced by `_`). Rows are OTU sequences, columns are samples, and each cell is the `num_hits` count. Use this table directly for downstream alpha-diversity based on the chosen marker.

The regression-derived metric weights learned from the taxonomic profile.

---

## üìê Scoring Overview

### Expert Mode (auto-selected)

Expert mode uses predefined weights combining normalized metrics (correlation to taxprof, group discriminability, richness, presence rate, singleton rate inversion, rarefaction slope inversion, and Shannon CV inversion). Lower-is-better metrics are inverted after min‚Äìmax normalization.

### Data-driven Mode (auto-selected when `--taxprof` provided)

Data-driven mode fits a regression using available metrics to predict the taxonomic-profile correlation and derives weights proportional to coefficient magnitudes and model R¬≤. The final score is a weighted sum of normalized (and inverted where appropriate) metrics; the strongest predictive metrics and correlation receive higher weights.

## üìù Example Workflow

1. Run SingleM across all samples with `singlem pipe`.
```bash
SAMPLES=(sample1 sample2 sample3)
for SAMPLE in "${SAMPLES[@]}"; do
    read1="/path/to/${SAMPLE}_R1.fastq.gz"
    read2="/path/to/${SAMPLE}_R2.fastq.gz"
    output_folder="/path/to/output/"
    singlem pipe -1 "$read1" -2 "$read2" --threads 8 \
        --taxonomic-profile "${output_folder}${SAMPLE}_singlem.tax.tsv" \
        --taxonomic-profile-krona "${output_folder}${SAMPLE}_singlem.tax-krona.html" \
        --otu-table "${output_folder}${SAMPLE}_singlem.otu.tsv"
done
```
2. Collect OTU tables and (optionally) taxonomic profiles.
3. Prepare metadata if you need group-separation scoring.
4. Run MarkerMuse in your preferred mode.
5. Select the highest-ranked marker gene for alpha-diversity estimation.

## ü§ù Contributing

Pull requests, suggestions, and issue reports are welcome. Please open an issue if you have ideas for additional scoring metrics or want support for other input/output formats.


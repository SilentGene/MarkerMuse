# MarkerMuse

MarkerMuse is a Python-based evaluation toolkit designed to identify the best-performing marker genes for computing alpha diversity from **SingleM** outputs. It analyzes OTU tables generated by SingleM and scores each marker gene using weighted (YAML-defined) and fitted (regression-derived) criteria.

This tool is useful when working with microbial community sequencing data where SingleM is used to detect marker genes across metagenomic or metatranscriptomic samples.

> [!NOTE]
> This library is still under development. The vision is to evolve it into a comprehensive toolkit that empowers researchers to cherry-pick the most suitable marker genes from their metagenomic datasets for alpha/beta diversity analyses, essentially bringing 16S amplicon sequencing capabilities to shotgun metagenomics. Future roadmap includes support for additional marker gene profiling tools beyond SingleM, plus enhanced visualization capabilities for downstream analyses. Stay tuned or drop your feature requests! üß¨

## ‚ú® Features

* Accepts multiple SingleM OTU tables as input.
* Supports **two scoring modes**:

  * **Weighted mode** ‚Äî uses human-curated metric weights loaded from `weights.yaml` (you can edit this file to customize scoring).
  * **Fitted mode** ‚Äî uses SingleM taxonomic-profile output to fit regression-based marker performance weights and rank markers according to how well they predict observed taxonomic coverage.
* Computes and normalizes multiple evaluation metrics, including:

  * OTU richness
  * Shannon diversity
  * Coverage variance across samples
  * Correlation to taxonomic-profile coverage
  * Replicate stability (bootstrapped)
* Produces a combined score and ranking of marker genes.
* Optional metadata input allows ANOVA-based group-separation scoring.
* Exports summary tables and visualizations (heatmap + top markers barplot).

---

## üì• Input Requirements

### 1. SingleM OTU tables (`*_singlem.otu.tsv`)

Tab-separated format containing:

```
gene    sample    sequence    num_hits    coverage    taxonomy
```

All OTU files for different samples should be placed in one folder.

### 2. (Optional) SingleM taxonomic-profile files (`*_singlem.tax.tsv`)

Required only for **data-driven mode**.

```
sample    coverage    taxonomy
```

This file provides average per-taxon coverage computed across all markers.

### 3. (Optional) Metadata file (`metadata.tsv`)

Must include:

```
sample    group
```

Used for group-separation scoring.

---

## üöÄ Installation

MarkerMuse is a pure-Python script.

### Install dependencies:

```bash
pip install pandas numpy scipy matplotlib
```

Clone or download this repository, and run the script directly.

---

## üß™ Usage

### Basic usage (weighted mode auto-selected)

If you do not supply a taxonomic profile (`--taxprof`), the script auto-selects weighted scoring using `weights.yaml`:

```bash
python markermuse.py \
  --input_folder /path/to/otu_files \
  --otu_suf _singlem.otu.tsv
```

### Fitted mode (auto-selected when `--taxprof` provided)

Provide a taxonomic profile to enable regression-based fitted scoring:

```bash
python markermuse.py \
  --input_folder /path/to/otu_files \
  --otu_suf _singlem.otu.tsv \
  --taxprof _singlem.tax.tsv
```

### With metadata

```bash
python markermuse.py \
    --input_folder otu/ \
    --otu_suf _singlem.otu.tsv \
    --mode expert \
    --metadata metadata.tsv
```

### Optional arguments

| Argument             | Description                                          |
| -------------------- | ---------------------------------------------------- |
| `--out_prefix`       | Output file prefix inside output folder (default: `marker_scores`) |
| `-o`, `--output_folder` | Output directory (default: `marker_muse_output`, auto-created) |
| `--bootstrap_n`      | Number of bootstrap replicates for stability scoring |
| `--rarefaction_reps` | Rarefaction resampling repetitions                   |
| `--taxprof`          | Suffix or path to SingleM taxonomic-profile (enables fitted mode) |
| `--metadata`         | Metadata TSV with `sample` & `group` for group ANOVA |
| `--min_markers_for_fit` | Minimum markers with taxprof to attempt regression |
| `--weights`          | Path to YAML file overriding default metric weights (weighted mode) |

---

## üìä Output Files

MarkerMuse generates the following outputs:

### 1. **`<output_folder>/<prefix>.tsv`**

Comprehensive tab-separated marker scoring table (sorted descending by `score`; `rank` is first column) written into the specified output folder. Columns include:

* `n_samples`: Number of samples in which the marker is detected
* `n_otus`: Total OTUs detected for the marker
* `mean_richness`: Average number of OTUs per sample
* `presence_rate`: Fraction of samples where the marker is present
* `singleton_rate`: Fraction of OTUs observed only once
* `cv_shannon`: Coefficient of variation of Shannon diversity across samples
* `slope_rarefaction`: Slope of rarefaction curve for the marker
* `F_group`: ANOVA F-statistic for group separation (if metadata provided)
* `mean_corr_taxprof`: Mean correlation between marker profile and taxonomic profile (fitted mode relevance)
* `score`: Combined weighted score
* `rank`: Rank of marker based on final score
* `mean_corr_taxprof_norm`: Normalized mean correlation
* `F_group_norm`: Normalized F_group
* `presence_rate_norm`: Normalized presence rate
* `mean_richness_norm`: Normalized mean richness
* `cv_shannon_norm`: Normalized CV of Shannon diversity
* `slope_rarefaction_norm`: Normalized rarefaction slope
* `singleton_rate_norm`: Normalized singleton rate

### 2. **`<output_folder>/<prefix>_heatmap.png`**

Heatmap of normalized marker metrics.

### 3. **`<output_folder>/<prefix>_topbar.png`**

Barplot of top-scoring markers.

### 4. **`<output_folder>/<prefix>_fitted_weights.txt`** (fitted mode only)

### 5. **`<output_folder>/<prefix>_best_<MARKER>_otu.tsv`**

OTU table for the highest-scoring marker gene. `<MARKER>` is the sanitized marker id (non-alphanumeric characters replaced by `_`). Rows are OTU sequences, columns are samples, and each cell is the `num_hits` count. Use this table directly for downstream alpha-diversity based on the chosen marker.

The regression-derived metric weights learned from the taxonomic profile.

---

## üìê Scoring Overview

### Weighted Mode (auto-selected)

Weighted mode loads metric weights from `weights.yaml`. You can edit this file to adjust the influence of each metric. Lower-is-better metrics are inverted after min‚Äìmax normalization (singleton_rate, slope_rarefaction, cv_shannon).

### Fitted Mode (auto-selected when `--taxprof` provided)

Fitted mode learns weights from data: it fits a regression using selected metrics to predict taxonomic-profile correlation. Coefficient magnitudes and model R¬≤ determine final weights (combining learned feature weights and direct correlation weight). Lower-is-better metrics are inverted after normalization.
## üßæ Customizing Weights (weighted mode)

Edit `weights.yaml` in the repository root to customize metric weights. Example default:

```yaml
mean_corr_taxprof: 0.30
F_group: 0.20
cv_shannon: 0.15
mean_richness: 0.10
slope_rarefaction: 0.10
singleton_rate: 0.10
presence_rate: 0.05
```

Notes:
* Values need not sum to exactly 1.0 (they are normalized internally).
* Omitted metrics default to 0 weight.
* If the file is malformed, internal defaults are used with a warning.
* You can supply an alternate file via `--weights custom_weights.yaml`.


## üìù Example Workflow

1. Run SingleM across all samples with `singlem pipe`.
```bash
SAMPLES=(sample1 sample2 sample3)
for SAMPLE in "${SAMPLES[@]}"; do
    read1="/path/to/${SAMPLE}_R1.fastq.gz"
    read2="/path/to/${SAMPLE}_R2.fastq.gz"
    output_folder="/path/to/output/"
    singlem pipe -1 "$read1" -2 "$read2" --threads 8 \
        --taxonomic-profile "${output_folder}${SAMPLE}_singlem.tax.tsv" \
        --taxonomic-profile-krona "${output_folder}${SAMPLE}_singlem.tax-krona.html" \
        --otu-table "${output_folder}${SAMPLE}_singlem.otu.tsv"
done
```
2. Prepare metadata if you need group-separation scoring.
3. Run MarkerMuse in your preferred mode.
```bash
# Fitted mode example
python markermuse.py \
  --input_folder /path/to/otu_files \
  --otu_suf _singlem.otu.tsv \
  --taxprof _singlem.tax.tsv \
  --output_folder /path/to/marker_muse_output
```
4. Select the highest-ranked marker gene for alpha-diversity estimation.

## ü§ù Contributing

Pull requests, suggestions, and issue reports are welcome. Please open an issue if you have ideas for additional scoring metrics or want support for other input/output formats.


# MarkerMuse

MarkerMuse is a Python-based evaluation toolkit designed to identify the best-performing marker genes for computing alpha diversity from **SingleM** outputs. It analyzes OTU tables generated by SingleM and scores each marker gene using expert-derived and data-driven criteria.

This tool is useful when working with microbial community sequencing data where SingleM is used to detect marker genes across metagenomic or metatranscriptomic samples.

---

## ‚ú® Features

* Accepts multiple SingleM OTU tables as input.
* Supports **two scoring modes**:

  * **Expert preset mode** ‚Äî heuristic scoring based on marker coverage consistency, richness, and stability.
  * **Data-driven mode** ‚Äî uses SingleM taxonomic-profile output to fit regression-based marker performance weights and rank markers according to how well they predict observed taxonomic coverage.
* Computes and normalizes multiple evaluation metrics, including:

  * OTU richness
  * Shannon diversity
  * Coverage variance across samples
  * Correlation to taxonomic-profile coverage
  * Replicate stability (bootstrapped)
* Produces a combined score and ranking of marker genes.
* Optional metadata input allows ANOVA-based group-separation scoring.
* Exports summary tables and visualizations (heatmap + top markers barplot).

---

## üì• Input Requirements

### 1. SingleM OTU tables (`*_singlem.otu.tsv`)

Tab-separated format containing:

```
gene    sample    sequence    num_hits    coverage    taxonomy
```

All OTU files for different samples should be placed in one folder.

### 2. (Optional) SingleM taxonomic-profile files (`*_singlem.tax.tsv`)

Required only for **data-driven mode**.

```
sample    coverage    taxonomy
```

This file provides average per-taxon coverage computed across all markers.

### 3. (Optional) Metadata file (`metadata.tsv`)

Must include:

```
sample    group
```

Used for group-separation scoring.

---

## üöÄ Installation

MarkerMuse is a pure-Python script.

### Install dependencies:

```bash
pip install pandas numpy scipy matplotlib
```

Clone or download this repository, and run the script directly.

---

## üß™ Usage

### Basic usage (expert preset mode)

```bash
python marker_muse.py \
    --input_folder /path/to/otu_files \
    --otu_suf _singlem.otu.tsv \
    --mode expert
```

### Data-driven mode

Requires `--taxprof`:

```bash
python marker_muse.py \
    --input_folder /path/to/otu_files \
    --otu_suf _singlem.otu.tsv \
    --mode data-driven \
    --taxprof _singlem.tax.tsv
```

### With metadata

```bash
python marker_muse.py \
    --input_folder otu/ \
    --otu_suf _singlem.otu.tsv \
    --mode expert \
    --metadata metadata.tsv
```

### Optional arguments

| Argument             | Description                                          |
| -------------------- | ---------------------------------------------------- |
| `--out_prefix`       | Output file prefix (default: `marker_scores`)        |
| `--bootstrap_n`      | Number of bootstrap replicates for stability scoring |
| `--rarefaction_reps` | Rarefaction resampling repetitions                   |
| `--verbose`          | Print additional logs                                |

---

## üìä Output Files

MarkerMuse generates the following outputs:

### 1. **`<prefix>.csv`**

Comprehensive marker scoring table including the following columns:

* `n_samples`: Number of samples in which the marker is detected
* `n_otus`: Total OTUs detected for the marker
* `mean_richness`: Average number of OTUs per sample
* `presence_rate`: Fraction of samples where the marker is present
* `singleton_rate`: Fraction of OTUs observed only once
* `cv_shannon`: Coefficient of variation of Shannon diversity across samples
* `slope_rarefaction`: Slope of rarefaction curve for the marker
* `F_group`: ANOVA F-statistic for group separation (if metadata provided)
* `mean_corr_taxprof`: Mean correlation between marker profile and taxonomic profile (data-driven mode)
* `score`: Combined weighted score
* `rank`: Rank of marker based on final score
* `mean_corr_taxprof_norm`: Normalized mean correlation
* `F_group_norm`: Normalized F_group
* `presence_rate_norm`: Normalized presence rate
* `mean_richness_norm`: Normalized mean richness
* `cv_shannon_norm`: Normalized CV of Shannon diversity
* `slope_rarefaction_norm`: Normalized rarefaction slope
* `singleton_rate_norm`: Normalized singleton rate

### 2. **`<prefix>_heatmap.png`**

Heatmap of normalized marker metrics.

### 3. **`<prefix>_topbar.png`**

Barplot of top-scoring markers.

### 4. **`<prefix>_fitted_weights.txt`** (data-driven mode only)

The regression-derived metric weights learned from the taxonomic profile.

---

## üìê Scoring Overview

### Expert Mode Scoring Formula

In expert preset mode, the final marker score is computed as a weighted sum of normalized metrics:

```
final_score = w_shannon * shannon_norm
             + w_evenness * evenness_norm
             + w_richness * richness_norm
             + w_stability * stability_norm
             + w_coverage * coverage_norm
```

Where:

* **shannon_norm**: Normalized Shannon diversity
* **evenness_norm**: Normalized Pielou‚Äôs evenness
* **richness_norm**: Normalized OTU richness
* **stability_norm**: Normalized cross-sample stability (CV / bootstrap)
* **coverage_norm**: Normalized marker coverage consistency

All metrics are scaled to 0‚Äì1 before weighting. The expert mode uses a predefined set of weights based on ecological heuristics.

### Data-driven Mode

In data-driven mode, markers are evaluated based on how well their abundance profiles predict the observed taxonomic profile. A regression is fitted for each marker to the taxonomic-profile coverage across samples, and markers are ranked according to the fitted weights and correlation statistics.

---

## üìù Example Workflow

1. Run SingleM across all samples with `singlem pipe`.
2. Collect OTU tables and (optionally) taxonomic profiles.
3. Prepare metadata if you need group-separation scoring.
4. Run MarkerMuse in your preferred mode.
5. Select the highest-ranked marker gene for alpha-diversity estimation.

---

## üìÑ License

MIT License (recommended, but modify as needed for your project).

---

## ü§ù Contributing

Pull requests, suggestions, and issue reports are welcome. Please open an issue if you have ideas for additional scoring metrics or want support for new SingleM output formats.

---

## üôå Acknowledgements

MarkerMuse was created to support robust alpha-diversity analysis from SingleM results, combining ecological intuition with data-driven modeling.

Happy analyzing! üéâ
